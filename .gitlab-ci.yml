variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_TLS_CERTDIR: ""

stages:
  - Build

build:
  stage: Build
  services:
    - docker:dind
  image: docker:latest
  script:
    - |
      ########## Build job ##########

      # Make sure you have a builder that supports multiâ€‘arch
      docker buildx create --name multiarch --use
      docker buildx inspect --bootstrap    # Installs QEMU and other helpers

      # Build and push the image
      docker buildx build --platform linux/arm64/v8 -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME" .

      # Login to the registry
      echo "$REGISTRY_PWD" | docker login -u $REGISTRY_USER --password-stdin $CI_REGISTRY

      # Push the image
      docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME"
