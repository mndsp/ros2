name: Build Docker Images

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      ros_distros:
        description: 'ROS distributions to build (comma-separated)'
        required: false
        default: 'humble,jazzy'
      hw_targets:
        description: 'Hardware targets to build (comma-separated)'
        required: false
        default: 'aarch64,x86_64'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build for ${{ matrix.ros_distro }} on ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ros_distro: ${{ fromJSON(format('[{0}]', inputs.ros_distros || '"humble","jazzy"')) }}
        arch: ${{ fromJSON(format('[{0}]', inputs.hw_targets || '"aarch64","x86_64"')) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip invalid combination (jazzy + jetpack-6.2)
        if: matrix.ros_distro == 'jazzy' && matrix.arch == 'jetpack-6.2'
        run: echo "Skipping invalid combination" && exit 0

      - name: Set base docker image and targeted platform
        run: |
          # Set base image based on ROS distribution
          if [[ "${{ matrix.ros_distro }}" == "humble" ]]; then
            echo "BASE_IMAGE=ubuntu:22.04" >> $GITHUB_ENV
          elif [[ "${{ matrix.ros_distro }}" == "jazzy" ]]; then
            echo "BASE_IMAGE=ubuntu:24.04" >> $GITHUB_ENV
          else
            echo "Unsupported ROS_DISTRO: ${{ matrix.ros_distro }}! Quitting..."
            exit 1
          fi

          # Set platform and base image according to architecture
          if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
            echo "PLATFORM=linux/arm64/v8" >> $GITHUB_ENV
            echo "BASE_IMAGE=arm64v8/$BASE_IMAGE" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            echo "PLATFORM=linux/amd64" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "jetpack-6.2" ]]; then
            echo "PLATFORM=linux/arm64/v8" >> $GITHUB_ENV
            echo "BASE_IMAGE=nvcr.io/nvidia/l4t-jetpack:r36.4.0" >> $GITHUB_ENV
          else
            echo "PLATFORM=${{ matrix.arch }}" >> $GITHUB_ENV
          fi

      - name: Set docker image and tag
        run: |
          PRJ_NAME=${{ github.event.repository.name }}
          NS_NAME=${{ github.repository }}
          NS_NAME=${NS_NAME%/*}          # remove trailing part of the string after the last slash

          # Sanitize repository name
          PRJ_NAME=${PRJ_NAME//[^a-zA-Z0-9.-]/-}     # remove special characters
          PRJ_NAME=${PRJ_NAME,,}                     # transform to lower case
          NS_NAME=${NS_NAME,,}                       # transform to lower case

          # Set image name
          echo "IMG_NAME=${NS_NAME}/${PRJ_NAME}" >> $GITHUB_ENV

          # Sanitize ARCH for tag name
          ARCH=${{ matrix.arch }}
          SANITIZED_ARCH=${ARCH//[^a-zA-Z0-9.-]/-}     # remove special characters
          SANITIZED_ARCH=${SANITIZED_ARCH,,}           # transform to lower case

          # Set tag
          if [[ "${{ env.ARCH }}" == "x86_64" ]]; then
            TAG=${{ matrix.ros_distro }}
          else
            TAG=${{ matrix.ros_distro }}-$SANITIZED_ARCH"
          fi
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORM }}
          build-args: |
            ROS_DISTRO=${{ matrix.ros_distro }}
            BASE_IMAGE=${{ env.BASE_IMAGE }}
          tags: |
            ghcr.io/${{ env.IMG_NAME }}:${{ env.TAG }}
          push: ${{ github.event_name != 'pull_request' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
