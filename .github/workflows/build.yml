name: Build Docker Images

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      ros_distros:
        description: 'ROS distributions to build (comma-separated)'
        required: false
        default: '"humble","jazzy"'
      hw_targets:
        description: 'Hardware targets to build (comma-separated)'
        required: false
        default: '"aarch64","x86_64"'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    permissions:
      contents: read
      packages: write
    name: Build for ${{ matrix.ros_distro }} on ${{ matrix.arch }}
    runs-on: ${{ format('{0}{1}', matrix.ros_distro == 'humble' && 'ubuntu-22.04' || matrix.ros_distro == 'jazzy' && 'ubuntu-24.04' || 'ubuntu-latest', matrix.arch == 'aarch64' && '-arm' || '') }}
    strategy:
      matrix:
        ros_distro: ${{ fromJSON(format('[{0}]', inputs.ros_distros || '"humble","jazzy"')) }}
        arch: ${{ fromJSON(format('[{0}]', inputs.hw_targets || '"aarch64","x86_64"')) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip invalid combination (jazzy + jetpack-6.2)
        if: matrix.ros_distro == 'jazzy' && matrix.arch == 'jetpack-6.2'
        run: echo "Skipping invalid combination" && exit 0

      - name: Set base docker image and targeted platform
        run: |
          # Set base image based on ROS distribution
          if [[ "${{ matrix.ros_distro }}" == "humble" ]]; then
            BASE_IMAGE=ubuntu:22.04
          elif [[ "${{ matrix.ros_distro }}" == "jazzy" ]]; then
            BASE_IMAGE=ubuntu:24.04
          else
            echo "Unsupported ROS_DISTRO: ${{ matrix.ros_distro }}! Quitting..."
            exit 1
          fi

          # Set platform and base image according to architecture
          if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
            echo "PLATFORM=linux/arm64/v8" >> $GITHUB_ENV
            BASE_IMAGE=arm64v8/$BASE_IMAGE
          elif [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            echo "PLATFORM=linux/amd64" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "jetpack-6.2" ]]; then
            echo "PLATFORM=linux/arm64/v8" >> $GITHUB_ENV
            BASE_IMAGE=nvcr.io/nvidia/l4t-jetpack:r36.4.0
          else
            echo "PLATFORM=${{ matrix.arch }}" >> $GITHUB_ENV
          fi

          echo "BASE_IMAGE=$BASE_IMAGE" >> $GITHUB_ENV

      - name: Set docker image and tag
        run: |
          PRJ_NAME=${{ github.event.repository.name }}
          NS_NAME=${{ github.repository }}
          NS_NAME=${NS_NAME%/*}          # remove trailing part of the string after the last slash

          # Sanitize repository name
          PRJ_NAME=${PRJ_NAME//[^a-zA-Z0-9.-]/-}     # remove special characters
          PRJ_NAME=${PRJ_NAME,,}                     # transform to lower case
          NS_NAME=${NS_NAME,,}                       # transform to lower case

          # Set image name
          # Append branch slug for non-default branches (like CI script)
          BRANCH_NAME=${{ github.ref_name }}
          DEFAULT_BRANCH=${{ github.event.repository.default_branch }}

          if [[ "$BRANCH_NAME" == "$DEFAULT_BRANCH" ]]; then
            echo "IMG_NAME=${NS_NAME}/${PRJ_NAME}" >> $GITHUB_ENV
          else
            # Sanitize branch name: keep only letters, digits, dashes and periods
            BRANCH_SLUG=${BRANCH_NAME//[^a-zA-Z0-9.-]/-}
            BRANCH_SLUG=${BRANCH_SLUG,,}
            echo "IMG_NAME=${NS_NAME}/${PRJ_NAME}/${BRANCH_SLUG}" >> $GITHUB_ENV
          fi

          # Sanitize ARCH for tag name
          ARCH=${{ matrix.arch }}
          SANITIZED_ARCH=${ARCH//[^a-zA-Z0-9.-]/-}     # remove special characters
          SANITIZED_ARCH=${SANITIZED_ARCH,,}           # transform to lower case

          # Set tag
          if [[ "$ARCH" == "x86_64" ]]; then
            echo "TAG=${{ matrix.ros_distro }}" >> $GITHUB_ENV
          else
            echo "TAG=${{ matrix.ros_distro }}-$SANITIZED_ARCH" >> $GITHUB_ENV
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORM }}
          build-args: |
            ROS_DISTRO=${{ matrix.ros_distro }}
            BASE_IMAGE=${{ env.BASE_IMAGE }}
          tags: |
            ghcr.io/${{ env.IMG_NAME }}:${{ env.TAG }}
          push: ${{ github.event_name != 'pull_request' }}
          # Disable Docker layer cache to force rebuilding all layers
          no-cache: true
          # Always pull the base image to ensure it's up-to-date
          pull: true
